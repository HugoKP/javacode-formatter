
<div CLASS="javacode" style="width:657px;"><pre><code>
<span CLASS="xt3wquy_reserved">package</span> br.com.hkp.showemojis;

<span CLASS="xt3wquy_reserved">import</span> <span CLASS="xt3wquy_reserved">static</span> br.com.hkp.showemojis.global.<span CLASS="xt3wquy_class">Global</span>.<span CLASS="xt3wquy_const">EMOJIS_DIRNAME</span>;
<span CLASS="xt3wquy_reserved">import</span> <span CLASS="xt3wquy_reserved">static</span> br.com.hkp.showemojis.global.<span CLASS="xt3wquy_class">Global</span>.<span CLASS="xt3wquy_const">SHOW_EMOJIS</span>;
<span CLASS="xt3wquy_reserved">import</span> java.io.<span CLASS="xt3wquy_class">BufferedReader</span>;
<span CLASS="xt3wquy_reserved">import</span> java.io.<span CLASS="xt3wquy_class">BufferedWriter</span>;
<span CLASS="xt3wquy_reserved">import</span> java.io.<span CLASS="xt3wquy_class">File</span>;
<span CLASS="xt3wquy_reserved">import</span> java.io.<span CLASS="xt3wquy_class">FileReader</span>;
<span CLASS="xt3wquy_reserved">import</span> java.io.<span CLASS="xt3wquy_class">FileWriter</span>;
<span CLASS="xt3wquy_reserved">import</span> java.io.<span CLASS="xt3wquy_class">IOException</span>;
<span CLASS="xt3wquy_reserved">import</span> java.nio.charset.<span CLASS="xt3wquy_class">StandardCharsets</span>;
<span CLASS="xt3wquy_reserved">import</span> java.util.<span CLASS="xt3wquy_class">HashMap</span>;
<span CLASS="xt3wquy_reserved">import</span> java.util.regex.<span CLASS="xt3wquy_class">Matcher</span>;
<span CLASS="xt3wquy_reserved">import</span> java.util.regex.<span CLASS="xt3wquy_class">Pattern</span>;



<span CLASS="xt3wquy_comment">/******************************************************************************
 * Esta classe tem todos os metodos para criar uma copia editada de uma pagina
 * salva com conversas no app WhatsApp Web.
 * &lt;p&gt;
 * Esta copia deve ser capaz de exibir os emojis inseridos pelo usuario. Ao 
 * contrario do que ocorrem com as paginas originalmente salvas.
 * &lt;p&gt;
 * @author "Pedro Reis"
 * @since 1 de novembro de 2020 v1.0
 * @version v1.0
 *****************************************************************************/</span>
<span CLASS="xt3wquy_reserved">public</span> <span CLASS="xt3wquy_reserved">final</span> <span CLASS="xt3wquy_reserved">class</span> <span CLASS="xt3wquy_class">WhatsAppEditor</span>
{
    <span CLASS="xt3wquy_comment">/*
    Localiza o atributo alt na tag que insere emojis
    */</span>
    <span CLASS="xt3wquy_reserved">private</span> <span CLASS="xt3wquy_reserved">static</span> <span CLASS="xt3wquy_reserved">final</span> <span CLASS="xt3wquy_class">Pattern</span> <span CLASS="xt3wquy_const">ALT_ATTR_PATTERN</span> = 
        <span CLASS="xt3wquy_class">Pattern</span>.<span CLASS="xt3wquy_function">compile</span>(<span CLASS="xt3wquy_literal">"alt\\s*=\\s*\".+?\""</span>);
    
    <span CLASS="xt3wquy_comment">/*
    Localiza tags que inserem emojis
    */</span>
    <span CLASS="xt3wquy_reserved">private</span> <span CLASS="xt3wquy_reserved">static</span> <span CLASS="xt3wquy_reserved">final</span> <span CLASS="xt3wquy_class">Pattern</span> <span CLASS="xt3wquy_const">EMOJI_TAG_PATTERN</span> = 
        <span CLASS="xt3wquy_class">Pattern</span>.<span CLASS="xt3wquy_function">compile</span>
        (
            <span CLASS="xt3wquy_literal">"&lt;img src=\"d5fceb6532643d0d84ffe09c40c481ecdf59e15a\\.gif.+?&gt;"</span>
        );
    
    <span CLASS="xt3wquy_comment">/*
    Aramazena todo o conteudo de um arquivo HTML
    */</span>
    <span CLASS="xt3wquy_reserved">private</span> <span CLASS="xt3wquy_reserved">final</span> <span CLASS="xt3wquy_class">StringBuffer</span> originalHtmlContent;
    
    <span CLASS="xt3wquy_comment">/*
    buffer para otimizar processos de leitura e gravacao
    */</span>
    <span CLASS="xt3wquy_reserved">private</span> <span CLASS="xt3wquy_reserved">final</span> <span CLASS="xt3wquy_reserved">int</span> buffer;
   
    <span CLASS="xt3wquy_comment">/*
    Arquivo que serah lido e arquivo que sera gravado
    */</span>
    <span CLASS="xt3wquy_reserved">private</span> <span CLASS="xt3wquy_reserved">final</span> <span CLASS="xt3wquy_class">File</span> inputFile;
    <span CLASS="xt3wquy_reserved">private</span> <span CLASS="xt3wquy_reserved">final</span> <span CLASS="xt3wquy_class">File</span> outputFile;
    
    <span CLASS="xt3wquy_comment">/*[00]---------------------------------------------------------------------
    
    -------------------------------------------------------------------------*/</span>
    <span CLASS="xt3wquy_comment">/**
     * Construtor da classe.
     * 
     * @param file O arquivo que deve ser processado para gerar uma copia com as
     * tags que inserem emojis editadas.
     */</span>
    <span CLASS="xt3wquy_reserved">public</span> <span CLASS="xt3wquy_class">WhatsAppEditor</span>(<span CLASS="xt3wquy_reserved">final</span> <span CLASS="xt3wquy_class">File</span> file)
    {
        inputFile = file;
        
        <span CLASS="xt3wquy_class">String</span> absoluteFileName = inputFile.<span CLASS="xt3wquy_function">getAbsolutePath</span>();
        
        buffer = (<span CLASS="xt3wquy_reserved">int</span>)inputFile.<span CLASS="xt3wquy_function">length</span>();
        
        originalHtmlContent = <span CLASS="xt3wquy_reserved">new</span> <span CLASS="xt3wquy_class">StringBuffer</span>(buffer / 2);
        
        outputFile = 
            <span CLASS="xt3wquy_reserved">new</span> <span CLASS="xt3wquy_class">File</span>
                (
                    absoluteFileName.<span CLASS="xt3wquy_function">replace</span>(<span CLASS="xt3wquy_literal">".html"</span>,<span CLASS="xt3wquy_literal">""</span>) + 
                    <span CLASS="xt3wquy_const">SHOW_EMOJIS</span> +
                    <span CLASS="xt3wquy_literal">".html"</span>
                );
    }<span CLASS="xt3wquy_comment">//construtor
</span>    
    <span CLASS="xt3wquy_comment">/*[01]---------------------------------------------------------------------
    
    -------------------------------------------------------------------------*/</span>
    <span CLASS="xt3wquy_comment">/**
     * Le o arquivo e copia seu conteudo para uma variavel interna do objeto.
     * 
     * @throws IOException Em caso de erro de IO.
     */</span>
    <span CLASS="xt3wquy_reserved">public</span> <span CLASS="xt3wquy_reserved">void</span> <span CLASS="xt3wquy_function">readFile</span>() <span CLASS="xt3wquy_reserved">throws</span> <span CLASS="xt3wquy_class">IOException</span>
    {
           
        <span CLASS="xt3wquy_class">BufferedReader</span> htmlFile = 
            <span CLASS="xt3wquy_reserved">new</span> <span CLASS="xt3wquy_class">BufferedReader</span>
            (
                <span CLASS="xt3wquy_reserved">new</span> <span CLASS="xt3wquy_class">FileReader</span>(inputFile, <span CLASS="xt3wquy_class">StandardCharsets</span>.<span CLASS="xt3wquy_const">UTF_8</span>), buffer
            );
        
        <span CLASS="xt3wquy_class">String</span> line;
        
        <span CLASS="xt3wquy_reserved">while</span> ((line = htmlFile.<span CLASS="xt3wquy_function">readLine</span>()) != <span CLASS="xt3wquy_reserved">null</span>)
            originalHtmlContent.<span CLASS="xt3wquy_function">append</span>(line).<span CLASS="xt3wquy_function">append</span>(<span CLASS="xt3wquy_literal">"\n"</span>);
        
        htmlFile.<span CLASS="xt3wquy_function">close</span>();
        
    }<span CLASS="xt3wquy_comment">//readFile()
</span>        
    <span CLASS="xt3wquy_comment">/*[02]---------------------------------------------------------------------
      
    -------------------------------------------------------------------------*/</span>
    <span CLASS="xt3wquy_comment">/**
     * Recebe uma string codificada em utf8 que eh o emoji a ser exibido e que
     * foi lida do valor do atributo alt. Na tag que insere emojis na pagina.
     *
     * Esta string eh utilizada para encontrar o nome do arquivo que tem a 
     * figura correspondente a este emoji.
     * 
     * @param utf8Emoji Um emoji codificado em utf8
     * 
     * @return O nome que deve ter o arquivo PNG com a imagem deste emoji
     */</span>
    <span CLASS="xt3wquy_reserved">public</span> <span CLASS="xt3wquy_reserved">static</span> <span CLASS="xt3wquy_class">String</span> <span CLASS="xt3wquy_function">utf8EmojiToFilename</span>(<span CLASS="xt3wquy_reserved">final</span> <span CLASS="xt3wquy_class">String</span> utf8Emoji)
    {
        <span CLASS="xt3wquy_class">StringBuilder</span> filename = <span CLASS="xt3wquy_reserved">new</span> <span CLASS="xt3wquy_class">StringBuilder</span>(64);
        
        filename.<span CLASS="xt3wquy_function">append</span>(<span CLASS="xt3wquy_const">EMOJIS_DIRNAME</span>).<span CLASS="xt3wquy_function">append</span>(<span CLASS="xt3wquy_literal">"/"</span>);
        
        <span CLASS="xt3wquy_comment">/*
        Le caractere por caractere utf8 e os converte para codepoint quando
        estes devem fazer parte da representacao normalizada do emoji
        */</span>        
        <span CLASS="xt3wquy_reserved">for</span> (<span CLASS="xt3wquy_reserved">int</span> position = 0; position &lt; utf8Emoji.<span CLASS="xt3wquy_function">length</span>(); position++)
        {
            <span CLASS="xt3wquy_reserved">char</span> c = utf8Emoji.<span CLASS="xt3wquy_function">charAt</span>(position);
            
            <span CLASS="xt3wquy_comment">/*
            VARIATION SELECTOR-16 e LOW SURROGATES caracteres nao sao inclusos
            na representacao normalizada de codepoints.
            */</span>
            <span CLASS="xt3wquy_reserved">if</span> ((c == '\ufe0f') || (<span CLASS="xt3wquy_class">Character</span>.<span CLASS="xt3wquy_function">isLowSurrogate</span>(c))) <span CLASS="xt3wquy_reserved">continue</span>;
                        
            filename.<span CLASS="xt3wquy_function">append</span>
            (
                <span CLASS="xt3wquy_class">String</span>.<span CLASS="xt3wquy_function">format</span>
                (
                  position == 0 ? <span CLASS="xt3wquy_literal">"%x"</span> : <span CLASS="xt3wquy_literal">"-%x"</span>, 
                  <span CLASS="xt3wquy_class">Character</span>.<span CLASS="xt3wquy_function">codePointAt</span>(utf8Emoji, position)
                )
            );
            
        }<span CLASS="xt3wquy_comment">//for
</span>        
        filename.<span CLASS="xt3wquy_function">append</span>(<span CLASS="xt3wquy_literal">".png"</span>);
        
        <span CLASS="xt3wquy_reserved">return</span> filename.<span CLASS="xt3wquy_function">toString</span>();
        
    }<span CLASS="xt3wquy_comment">//utf8EmojiToFilename()
</span>    
    <span CLASS="xt3wquy_comment">/*[03]---------------------------------------------------------------------
    A partir da tag que insere emojis no arquivo original, este metodo retorna
    uma outra tag que irah inserir o emoji na copia alterada deste arquivo.
    -------------------------------------------------------------------------*/</span>
    <span CLASS="xt3wquy_reserved">private</span> <span CLASS="xt3wquy_class">String</span> <span CLASS="xt3wquy_function">getNewTag</span>(<span CLASS="xt3wquy_reserved">final</span> <span CLASS="xt3wquy_class">String</span> oldTag)
    {
        <span CLASS="xt3wquy_class">Matcher</span> <span CLASS="xt3wquy_function">matcher</span> = <span CLASS="xt3wquy_const">ALT_ATTR_PATTERN</span>.<span CLASS="xt3wquy_function">matcher</span>(oldTag);
        
        <span CLASS="xt3wquy_reserved">if</span> (<span CLASS="xt3wquy_function">matcher</span>.<span CLASS="xt3wquy_function">find</span>()) 
        {
            <span CLASS="xt3wquy_class">String</span> utf8Emoji = <span CLASS="xt3wquy_function">matcher</span>.<span CLASS="xt3wquy_function">group</span>();
            
            utf8Emoji = utf8Emoji.<span CLASS="xt3wquy_function">substring</span>
                        (
                            utf8Emoji.<span CLASS="xt3wquy_function">indexOf</span>(<span CLASS="xt3wquy_char">'"'</span>) + 1, utf8Emoji.<span CLASS="xt3wquy_function">length</span>() - 1
                        ).<span CLASS="xt3wquy_function">trim</span>();
            
            <span CLASS="xt3wquy_reserved">return</span> 
                <span CLASS="xt3wquy_literal">"&lt;img src=\""</span> + 
                <span CLASS="xt3wquy_function">utf8EmojiToFilename</span>(utf8Emoji) +
                <span CLASS="xt3wquy_literal">"\" alt=\""</span> +
                utf8Emoji +
                <span CLASS="xt3wquy_literal">"\" width=\"20px\" height=\"20px\"&gt;"</span>;
        } 
        <span CLASS="xt3wquy_reserved">else</span>
            <span CLASS="xt3wquy_reserved">return</span> <span CLASS="xt3wquy_reserved">null</span>;
  
    }<span CLASS="xt3wquy_comment">//getNewTag()
</span>    
    <span CLASS="xt3wquy_comment">/*[04]---------------------------------------------------------------------
      Retorna um HashMap associando cada tag que foi encontrada no arquivo
      original a tag que deve substitui-la na copia editada deste arquivo.
    -------------------------------------------------------------------------*/</span>
    <span CLASS="xt3wquy_reserved">private</span> <span CLASS="xt3wquy_class">HashMap</span>&lt;<span CLASS="xt3wquy_class">String</span>, <span CLASS="xt3wquy_class">String</span>&gt; <span CLASS="xt3wquy_function">getMap</span>() <span CLASS="xt3wquy_reserved">throws</span> <span CLASS="xt3wquy_class">IOException</span>
    {
        <span CLASS="xt3wquy_class">Matcher</span> <span CLASS="xt3wquy_function">matcher</span> = <span CLASS="xt3wquy_const">EMOJI_TAG_PATTERN</span>.<span CLASS="xt3wquy_function">matcher</span>(originalHtmlContent);
              
        <span CLASS="xt3wquy_class">HashMap</span>&lt;<span CLASS="xt3wquy_class">String</span>, <span CLASS="xt3wquy_class">String</span>&gt; map = <span CLASS="xt3wquy_reserved">new</span> <span CLASS="xt3wquy_class">HashMap</span>&lt;&gt;();
        
        <span CLASS="xt3wquy_reserved">while</span> (<span CLASS="xt3wquy_function">matcher</span>.<span CLASS="xt3wquy_function">find</span>())
            map.<span CLASS="xt3wquy_function">put</span>(<span CLASS="xt3wquy_function">matcher</span>.<span CLASS="xt3wquy_function">group</span>(), <span CLASS="xt3wquy_function">getNewTag</span>(<span CLASS="xt3wquy_function">matcher</span>.<span CLASS="xt3wquy_function">group</span>()));
       
        <span CLASS="xt3wquy_reserved">return</span> map;
   
    }<span CLASS="xt3wquy_comment">//getMap()
</span>      
    <span CLASS="xt3wquy_comment">/*[05]---------------------------------------------------------------------
        
    -------------------------------------------------------------------------*/</span>
    <span CLASS="xt3wquy_comment">/**
     * Grava um novo arquivo. Neste arquivo os emojis sao renderizados.
     * 
     * @throws IOException Em caso de erro de IO.
     */</span>
    <span CLASS="xt3wquy_reserved">public</span> <span CLASS="xt3wquy_reserved">void</span> <span CLASS="xt3wquy_function">createNewFile</span>() <span CLASS="xt3wquy_reserved">throws</span> <span CLASS="xt3wquy_class">IOException</span>
    {
        <span CLASS="xt3wquy_class">BufferedWriter</span> htmlFile = 
            <span CLASS="xt3wquy_reserved">new</span> <span CLASS="xt3wquy_class">BufferedWriter</span>
            (
                <span CLASS="xt3wquy_reserved">new</span> <span CLASS="xt3wquy_class">FileWriter</span>(outputFile, <span CLASS="xt3wquy_class">StandardCharsets</span>.<span CLASS="xt3wquy_const">UTF_8</span>), buffer
            );
        
        <span CLASS="xt3wquy_class">String</span> newHtmlContent = originalHtmlContent.<span CLASS="xt3wquy_function">toString</span>();
        
        <span CLASS="xt3wquy_class">HashMap</span>&lt;<span CLASS="xt3wquy_class">String</span>, <span CLASS="xt3wquy_class">String</span>&gt; tagMap = <span CLASS="xt3wquy_function">getMap</span>();
        
        <span CLASS="xt3wquy_reserved">for</span>(<span CLASS="xt3wquy_class">String</span> oldTag: tagMap.<span CLASS="xt3wquy_function">keySet</span>())
            newHtmlContent = newHtmlContent.<span CLASS="xt3wquy_function">replace</span>(oldTag, tagMap.<span CLASS="xt3wquy_function">get</span>(oldTag));
       
        htmlFile.<span CLASS="xt3wquy_function">write</span>(newHtmlContent);
        
        htmlFile.<span CLASS="xt3wquy_function">close</span>();
        
    }<span CLASS="xt3wquy_comment">//createNewFile()
</span>    
}<span CLASS="xt3wquy_comment">//classe WhatsAppEditor
</span>
</code></pre>
<div CLASS="linenumber">
000</br>001</br>002</br>003</br>004</br>005</br>006</br>007</br>008</br>009</br>010</br>011</br>012</br>013</br>014</br>015</br>016</br>017</br>018</br>019</br>020</br>021</br>022</br>023</br>024</br>025</br>026</br>027</br>028</br>029</br>030</br>031</br>032</br>033</br>034</br>035</br>036</br>037</br>038</br>039</br>040</br>041</br>042</br>043</br>044</br>045</br>046</br>047</br>048</br>049</br>050</br>051</br>052</br>053</br>054</br>055</br>056</br>057</br>058</br>059</br>060</br>061</br>062</br>063</br>064</br>065</br>066</br>067</br>068</br>069</br>070</br>071</br>072</br>073</br>074</br>075</br>076</br>077</br>078</br>079</br>080</br>081</br>082</br>083</br>084</br>085</br>086</br>087</br>088</br>089</br>090</br>091</br>092</br>093</br>094</br>095</br>096</br>097</br>098</br>099</br>100</br>101</br>102</br>103</br>104</br>105</br>106</br>107</br>108</br>109</br>110</br>111</br>112</br>113</br>114</br>115</br>116</br>117</br>118</br>119</br>120</br>121</br>122</br>123</br>124</br>125</br>126</br>127</br>128</br>129</br>130</br>131</br>132</br>133</br>134</br>135</br>136</br>137</br>138</br>139</br>140</br>141</br>142</br>143</br>144</br>145</br>146</br>147</br>148</br>149</br>150</br>151</br>152</br>153</br>154</br>155</br>156</br>157</br>158</br>159</br>160</br>161</br>162</br>163</br>164</br>165</br>166</br>167</br>168</br>169</br>170</br>171</br>172</br>173</br>174</br>175</br>176</br>177</br>178</br>179</br>180</br>181</br>182</br>183</br>184</br>185</br>186</br>187</br>188</br>189</br>190</br>191</br>192</br>193</br>194</br>195</br>196</br>197</br>198</br>199</br>200</br>201</br>202</br>203</br>204</br>205</br>206</br>207</br>208</br>209</br>210</br>211</br>212</br>213</br>214</br>215</br>216</br>217</br>218</br>219</br>220</br>221</br>222</br>223</br>224</br>225</br>226</br>227</br>228</br>229</br>230</br>231</br>232</br>233</br>234</br>235</br>236</br>237</br>238</br>239</br>240</br>241</br>242</br>243</br>244</br>245</br>
</div></div>